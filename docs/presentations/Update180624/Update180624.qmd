---
title: "GLharmonizeR - bringing together multiple sources of water quality data"
title-slide-attributes:
  data-background-image: ../../figsTables/logoNoWords.png
  data-background-size: contain
  data-background-opacity: "0.2"

author: 
  - name: Christian Coffman
    email: coffman.christian@epa.gov
    roles: 
      - Implementation
      - Design 
    affiliations: 
      - name: ORAU - ORD-CCTE-SCDCD-DMMB

  - name: Dr. Kelsey Vitense 
    roles: 
      - Mentor
      - Conceptualization
      - Design 
    affiliations: 
      - name: ORAU - ORD-CCTE-SCDCD-DMMB
      

format:
  revealjs:
    smaller: true
    scrollable: true
    theme: moon 
    logo: ../../figsTables/logo.png
    footer: "GLHarmonizeR"
    mermaid:
      theme: dark
---

# Introduction to me

:::: {.columns}
::: {.column width="40%"}
```{r, myTravelMap}
#| echo: false
#| eval: true
#| file: images/travelMap.R
```

:::

::: {.column width="60%"}
- From / now working in Duluth
- Study physics/chemistry
- Started as EPA contractor last fall
- Working on:
  - hydrodynamic simulation model in Lake Ontario
  - Harmonizing water quality data across great lakes
:::
::::

```{mermaid myTimeline}
%%| file: images/myTimeline.mmd
```

# Project context
## Harmful algal blooms are detrimental
- [Algal blooms are a catch-all name that includes any disproportionate growth of algae](https://www.iwla.org/publications/outdoor-america/articles/outdoor-america-2020-issue-2/algal-blooms-the-causes-dangers-and-some-solutions)
- Harmful algal blooms are a subset that are toxic to humans and animals
  - microcystins damage liver, brain
  - more potent than cyanide
- Public burden
  - Beach closures
  - Make animals severely sick (deadly)
  - Poisoning lake harvested foods

## HABs are increasing in frequency
- [HAB frequency increased recent years](https://pubs.acs.org/doi/10.1021/acs.est.9b03726#:~:text=Widespread%20coastal%20eutrophication%20is%20known%20to%20increase%20the,to%20increased%20prevalence%20and%20earlier%20timing%20of%20HABs.)
  - By as much as 40% / decade as in the Chinese coast
- Eutrophication - overly enriched with nutrients
  - Runoff from agriculture
  - Increased rain burden in certain areas

## HABs are difficult to predict
- Predictions using strictly nutrient loads less accurate in extreme bloom years
- Observed nutrient loadings have lead to better prediction
- https://www.nature.com/articles/s43247-022-00510-w
- Data are hosted in many different locations making it hard for researchers
- Other efforts have 
  - Focused on smaller inland lakes (LAGOS)
  - Cleaned/formatted the water quality portal (TADA)
- None have 
  - Harmonized all water quality measures from their source

# Project design

:::: {.columns}
::: {.column width="40%"}
```{mermaid packageUse}
flowchart TB
  install[Install R package] --> query[Select data] --> download[Save locally]
```
:::

::: {.column width="40%"}

```{mermaid simpleSketch}
flowchart LR
  NOAA --> NormNOAA[Normalize] --> StanNOAA[Standardize] --> Join
  GLENDA --> NormGLENDA[Normalize] --> StanGLENDA[Standardize] --> Join
  NCCA --> NormNCCA[Normalize] --> StanNCCA[Standardize] --> Join
  CSMI --> NormCSMI[Normalize] --> StanCSMI[Standardize] --> Join
  
```
:::
:::
- [Harmonize](https://www.nature.com/articles/s41597-024-02956-3) water quality measures across
- R package/Shiny app to make it accessible to researchers

- Lesson learned - spend time to design / diagram code structure
  - Helps create bite-sized chunks
  - Can design tests for test-based development
  - Helps with consistent code
  - Helps anticipate problems in meetings



# Project Implementation

## Version control / collaboration
- Version controlled using Git
- Collaboration via Github
- Major tasks documented through Github Issues
- Code review via Github PR viewer
- Documentation on Github Wiki
- Technical / meeting notes in Microsoft One Note
- Data set storage on Github
- Developer environment controlled through Renv

PICTURE OF GIT HISTORY

- Lesson - It is ok to use multiple tools for documentation note taking, especialy if it eases collaboration

## Styling
:::: {.columns}
::: {.column width="59%"}
- Strict code styling
  - [tidyverse  style guide](https://style.tidyverse.org/) for consistency
  - [Google software engineering](https://abseil.io/resources/swe-book/html/toc.html) for design
  - Design diagrams 
  - Maintainer won't need to be a chemist necessarily
- Standard R package structure
:::

::: {.column width="39%"}
![](images/sweGoogle.png){width="50%"}
![](images/niceComment.png){width="50%"}
:::
:::

- Lesson learned - adhering to code styles will make code reviews better/more enjoyable

## Standardization
:::: {.columns}
::: {.column width="59%"}
- Standardization (renaming/unit conversions) updated through excel 
  - Amenable to future changes
  - Updating naming doesn't require programming expertise
:::

::: {.column width="39%"}
ANALYTES3 screenshot!!!!
:::
:::


## UI 
:::: {.columns}
::: {.column width="59%"}
- Shiny app 
  - GUI for easy user interface
:::

::: {.column width="39%"}
SHINY PICTURE!!!
- Lesson learned - implementing Good LSP saves a lot of time (I knew nothing about Shiny, but yet had a functioning front end in few hours)
:::
:::



## Quality Assurance
- Code Review
  - Mentor (Kelsey) and I
  - Lessons learned
    - Couldn't explain or remember how code work so add a comment
    - If someone asks about code comment on it
- testthat package
  - report by covr
- Beta  dataset to GLTED folks
  - We used statistics lens
  - They will use their specific expertise
- Janet Lee - steered us in right direction
- Josh Powell - advisded on Github actions


## Documentation
- Product
- Developer
- Vignettes on how to reformat the data for common modeling purposes
- Academic paper associated with release
- Serves as an effort to help modeling effort in Lake Michigan
- Function documentation translated automatically through ROxygen2

## Development Timeline

{{< include ../../figsTables/design/initialDevelopmentMatrix.md >}}

## Back and forth with subject experts
- Iteractive/cyclic process
- collaboration with GLTED, NCCA, CSMI, and GLENPO 
- Ryan is a research Lymnoligist/Chemist
- Rigorous definition of chemistry names that are consistent 
- Working with Dan Kelley to fix issues in oce R package for CTD 

```{mermaid devCycle}
%%| file: ../../figsTables/design/developmentCycle.mmd
```

- Lesson learned - Being overly communicative is better than underly communactive

# Technical details

:::: {.columns}

::: {.column width="40%"}
- Scattered
  - Local
  - Cloud
  - Private Databases
- Different formats
  - Dates
  - Coordinates
  - Feature naming
- Living
  - Need to reproducibly assemble and QC
:::

::: {.column width="60%"}
```{mermaid}
%%| file: ../../figsTables/dataProcessing.md
```
:::

::::



# Current issues
- Working with an outdated GLENDA SOAP API
- Also the SeaBird API


# Other Lessons learned
- Tips to incorporate
  - If problem is intractable, don't know where to start. Just start somewhere it'll generally then give a clearer perspective on how  (documentation)
  - good is better than perfect (Not always adhering to design aims can be good... in moderation)
  - Workflow
    - Script
    - Write any checks I do as tests
    - Make it a function
  - Creating one-off non-reproducible intermediates is OK to communicate to collaborators