---
title: "GLharmonizeR - bringing together multiple sources of water quality data"
title-slide-attributes:
  data-background-image: ../../figsTables/logoNoWords.png
  data-background-size: contain
  data-background-opacity: "0.2"

author: 
  - name: Christian Coffman
    email: coffman.christian@epa.gov
    roles: 
      - Implementation
      - Design 
    affiliations: 
      - name: ORAU - ORD-CCTE-SCDCD-DMMB

  - name: Dr. Kelsey Vitense 
    roles: 
      - Mentor
      - Conceptualization
      - Design 
    affiliations: 
      - name: ORD-CCTE-SCDCD-DMMB
      

format:
  revealjs:
    embed-resources: true
    smaller: true
    theme: moon 
    logo: ../../figsTables/logo.png
    footer: "GLHarmonizeR"
    mermaid:
      theme: dark
execute: 
  cache: true
---

# My introduction

- From / now working in Duluth
- Studied Physics/chemistry
- Finishing Biostatistics PhD UMN
- ORAU Projects:
  - Mathematical modeling (hydrodynamics) in Lake Ontario
  - Harmonizing water quality data from multiple sources

```{mermaid myTimeline}
%%| file: images/myTimeline.mmd
```

## Acknowledgements

This work was supported by many folks across EPA offices/regions, USGS, and NOAA

::: {style="font-size: 60%;"}
:::: {.columns}
::: {.column width="50%"}
![[source: The Horizon Foundation](https://www.thehorizonfoundation.org/pregunta-sobre-ciudadania-en-el-censo-del-2020-perjudica-iniciativas-de-equidad/business-group-with-hands-together-teamwork-concepts/)](images/together.jpg)
:::

::: {.column width="25%"}
- ORD data/modeling team
  - James Pauer (GLTED)
  - Thomas Hollenhorst (GLTED)
  - Terry Brown (SCDCD)
  - Ryan Lepak (GLTED)
  - Aabir Banerji (GLTED)
  - Brandon Jarvis (CEMM)
  - Wilson Melendez (GDIT)
  - Jonathon Launspach (GDIT)
:::

::: {.column width="25%"}
- CSMI
  - Joel Hoffman (GLTED)
  - Anett Trebitz (GLTED)
  - Ralph Tingley (USGS)
- GLENDA
  - Elizabeth Hinchey (GLNPO)
  - Kenneth Klewin (GLNPO)
  - Eric Osantowski (GLNPO)
- NCCA
  - Hugh Sullivan (OW)
  - Sarah Lehmann (OW)
- NOAA
  - Steve Pothoven (NOAA/GLERL)
:::
::::
:::

# Project context
## Algal blooms can be harmful
:::: {.columns}
::: {.column width="50%"}
- [Harmful algal blooms (HABs) - toxic outgrowths of algae]((https://www.iwla.org/publications/outdoor-america/articles/outdoor-america-2020-issue-2/algal-blooms-the-causes-dangers-and-some-solutions))
  - Microcystins - more potent than cyanide
  - Damage liver, brain
- [HAB frequency increased recent years](https://pubs.acs.org/doi/10.1021/acs.est.9b03726#:~:text=Widespread%20coastal%20eutrophication%20is%20known%20to%20increase%20the,to%20increased%20prevalence%20and%20earlier%20timing%20of%20HABs.)
:::

::: {.column width="50%"}
- Public burden
  - Beach closures
  - Make animals dangerously sick
  - Harm food supply
  - [>$1bn over 10 years](https://www.ewg.org/research/high-cost-of-algae-blooms)
:::
:::

::: {#fig-bloom}
![](images\algalBloom.jpg)

Algal bloom in Lake Erie. credit: Ohio Sea Grant & Stone Lab 
:::



## Modeled in Lake Erie using ML 
- ML models successfully predict HABs, or Chlorophyll-a (Chla), in Lake Erie
- [Measured nutrient concentrations necessary for reliable prediction](https://www.nature.com/articles/s43247-022-00510-w)

::: {#fig-elephants layout-ncol=1}

![](images/lakeErieR2.png)

Predictions in Lake Erie from [Gupta et al. 2023](https://www.sciencedirect.com/science/article/pii/S0048969723044042)
:::


## Main goals/questions 
- Use ML to predict Chl-a as proxy for HABS in Lake Michigan (similar to Lake Michigan)
- How accurately can we predict Chl-a at specific location, time, and depth in the lake?
- What is the relative imporatance of Chl-a predictors and a minimum covariate set for prediction?

::: {.callout-warning collapse="true"}
# No unified data source
Need a unified data source to train "data-hungry" ML models
:::



## Sub-Goal: Assemble WQ data and make it accessible
- Assemble WQ data from multiple sources
  - GLENDA
  - NOAA
  - CSMI
  - NCCA

::: {.callout}
# Sub-Sub goal: Make data assemblage available to others
- Other scientists could use this data for Trends, associations, etc.
- Assembling and harmonizing takes a lot of effort
- Reproducible data assembly pipeline
  - Made into R package
- Inspired by similar R packages
  - LAGOSUS: harmonize WQ from WQP, NLA, and NEON- inland lakes
  - finsyncR: harmonize federal macroinvertebrate and fish data 
:::

## Data Overview

| Source | Purpose |  Access |
| :----- | :------ |  :----- |
| Great Lakes National Program Office survey (GLNPO) | Track changes in water quality of Great Lakes open waters | GLENDA on EPA Central Data Exchange (CDX); Password protected API |
| National Coastal Condition Assessment survey (NCCA) | Assess condition of coastal waters | Freely available on NARS website |
| Cooperative Science and Monitoring Initiative survey (CSMI) | US/Canada-coordinated GL science/monitoring under GLWQA | Local Access databases and Excel spreadsheets |
| Great Lakes Environmental Research Laboratory survey (NOAA) | Annual survey for SE Lake Michigan |  By Request from NOAA  |


# Project design

## Sketch and Benefits
- Federal GL WQ data in one place, [harmonized](https://www.nature.com/articles/s41597-024-02956-3)
  - Normalize the format 
  - Standardize naming and units
- Incorporates institutional knowledge
  - Consistent treatment of censored values
- Includes common water quality parameters across survey (aims for simplicity)
- R package/Shiny app to make it accessible to researchers

:::: {.columns}
::: {.column width="50%"}
```{mermaid}
%%| label: fig-simpleSketch
%%| fig-cap: "What package does"

flowchart LR
  NOAA --> NormNOAA[Normalize] --> cleanNOAA[Clean] --> StanNOAA[Standardize] --> Join
  GLENDA --> NormGLENDA[Normalize] --> cleanGLENDA[Clean] --> StanGLENDA[Standardize] --> Join
  NCCA --> NormNCCA[Normalize] --> cleanNCCA[Clean] --> StanNCCA[Standardize] --> Join
  CSMI --> NormCSMI[Normalize] --> cleanCSMI[Clean] --> StanCSMI[Standardize] --> Join
```
:::
::: {.column width="50%"}
```{mermaid}
%%| label: fig-packageUse
%%| fig-cap: "What user does"

flowchart TB
  install["Install R package"] --> query["Select data"]
```
:::

:::


## Function diagram {.scrollable}
```{mermaid idealDesign}
%%| file: ../../figsTables/design/functionDesign.mmd
```


::: {.callout-tip}
## Design / diagram code structure
- Helps create bite-sized chunks
- Can design tests for test-based development
- Helps with consistent code
- Helps anticipate problems in meetings
:::


# Project Implementation

## Version control / collaboration

:::: {.columns}
::: {.column width="50%"}
- Version controlled using Git
- Feature branch workflow
- Github for: Collaboration, Issues, PR/Code Review, User docs wiki
- Technical / meeting notes in Microsoft One Note
- Difficult-to-access data stored on Github
- Developer environment controlled through Renv
:::

::: {.column width="50%"}
![](images/gitBranches.png)
:::
:::

::: {.callout-tip}
## Faster alone further together

Using already established tools helps with collaboration
:::


## Styling
:::: {.columns}
::: {.column width="59%"}
- Code styling
  - [tidyverse  style guide](https://style.tidyverse.org/) for consistency
  - [Google software engineering](https://abseil.io/resources/swe-book/html/toc.html) for design
- Standard R package structure
- Maintainabilty
![](images/niceComment.png)

::: {.callout-tip}
## SWE vs programming
$$ SWE = \int \text{Programming } dt $$
:::

:::

::: {.column width="39%"}
![](images/sweGoogle.png)
:::
:::



## Normalization / Standardization
- Normalization: Case-by-case
- Standardization (renaming/unit conversions) updated through excel
  - Amenable to future changes
  - Updating naming doesn't require programming expertise

![Mapping table](images/mappingTable.png)


## User Interface
![](images/shinyApp.png)


::: {.callout-tip}
## Good LSP saves time
Didn't know Shiny, but had functioning front end prototype extremely quickly
:::


## Quality Assurance (People power)
- Code Review
- Beta  dataset to GLTED ecologists and modelers
- Beta package to ORD data scientists

::: {.callout-tip}
## Comment generously
- Can't explain or remember how code work...  add a comment
- Someone asks about code... add a comment 
:::

## Quality Assurance (Automated)
- Unit testing
  - [testthat](https://testthat.r-lib.org/) - unit tests
  - [covr](https://covr.r-lib.org/) - Test coverage
  - Janet Lee advised developing and organizing unit tests

- [Github R actions](https://github.com/r-lib/actions) (under construction) - advised by Josh Powell 
  - Protect the main branch
  - Automate all Unit tests
  - Enforce code styling
  - Frees us humans up for code review


## Documentation

:::: {.columns}
::: {.column width="40%"}
- Product (under construction)
  - Installation
  - Usage
  - Details for Technical experts (environmental chemistry)
- Vignettes (under construction) on how to reformat the data for common modeling purposes
- Journal article (planned) 
  - Design
  - Development process/decisions
:::

::: {.column width="60%"}
![README contains contributor information. Styling, format, contributing, and discussions.](images/README.png)
:::
:::


## Implementing expert opinions
- Iterative/cyclic process
- Collaboration with CSMI, NCCA, NOAA, and GLNPO 
- Rigorous, consistent definition of WQ names - GLTED

```{mermaid devCycle}
%%| file: ../../figsTables/design/developmentCycle.mmd
```

::: {.callout-tip}
## Communication is key
Being overly communicative is better than underly communicative
:::

## Development timeline
```{mermaid devTimeline}
%%| file: ../../figsTables/design/v1RoadMap.mmd
```


# Future directions
- Expand data sourcing
  - Incorporate state agency data from the water water quality portal
  - Incorporate tributary data
  - Expand to all the great lakes
  - Integrated statistical models "sharing" information across lakes
- More user options (filtering)
  - Add a reccommended cleaning function




# Other Lessons learned

::: {.callout-tip}
## Lesson Learned

- Workflow
  - Script
  - Write any checks I do as tests
  - Make it a function
- Good Coding / SWE practices
  - Almost always helps
  - Doesn't add much mental / time demand becomes part of your flow
- good is better than perfect (Not always adhering to design aims can be good... in moderation)
- Intermediate products don't need to be reproducible
:::


# Thank you 
